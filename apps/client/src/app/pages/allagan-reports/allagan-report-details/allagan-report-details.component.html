<ng-container *ngIf="itemId$ | async as itemId">
  <ng-container *ngIf="itemDetails$ | async as details">
    <div class="top-bar">
      <div fxLayout="row" fxLayoutGap="10px">
        <app-item-icon [itemId]="itemId"></app-item-icon>
        <div class="item-name-title">{{itemId | itemName | i18n}}</div>
      </div>
    </div>
    <nz-divider [nzText]="'ALLAGAN_REPORTS.Reports' | translate" nzOrientation="left"></nz-divider>
    <div class="reports">
      <nz-empty *ngIf="details.reports.length === 0" [nzNotFoundContent]="'ALLAGAN_REPORTS.No_reports' | translate"></nz-empty>
      <app-lazy-scroll [trackBy]="trackByUid" [displayedRows]="4" rowSize="130" [data]="details.reports" [rowTemplate]="reportTpl">
        <ng-template #reportTpl let-entry>
          <app-allagan-report-row [report]="entry" [userIsChecker]="isChecker$ | async"
                                  [userId]="userId$ | async" [reportsQueue]="itemReportsQueue$ | async"
                                  [focusId]="hoverId$ | async"
                                  (delete)="suggestDeletion(entry)" (edit)="startModification(entry)"></app-allagan-report-row>
        </ng-template>
      </app-lazy-scroll>
    </div>
    <nz-divider [nzText]="'ALLAGAN_REPORTS.Pending_changes' | translate" nzOrientation="left"></nz-divider>
    <div class="pending-reports" *ngIf="itemReportsQueue$ | async as queue">
      <nz-empty *ngIf="queue.length === 0" [nzNotFoundContent]="'ALLAGAN_REPORTS.No_pending_changes' | translate"></nz-empty>
      <app-lazy-scroll [trackBy]="trackByUid" [displayedRows]="4" rowSize="130" [data]="queue" [rowTemplate]="reportQueueEntryTpl">
        <ng-template #reportQueueEntryTpl let-entry>
          <app-allagan-report-row [queueEntry]="entry" [userIsChecker]="isChecker$ | async"
                                  [userId]="userId$ | async"
                                  (accept)="accept(entry)" (reject)="reject(entry)"
                                  (mouseenter)="hoverQueueEntry(entry)"
                                  (mouseleave)="hoverId$.next(null)"></app-allagan-report-row>
        </ng-template>
      </app-lazy-scroll>
    </div>
    <nz-divider [nzText]="formTitle" nzOrientation="left"></nz-divider>
    <ng-template #formTitle>
      <span *ngIf="!modificationId">{{'ALLAGAN_REPORTS.New_report' | translate}}</span>
      <span *ngIf="modificationId">{{'ALLAGAN_REPORTS.Suggest_modification' | translate}}</span>
    </ng-template>
    <div class="add-source">
      <form nz-form [formGroup]="form"
            (ngSubmit)="modificationId ? submitModification(itemId, modificationId) : addSource(itemId)">
        <nz-form-item>
          <nz-form-label [nzSpan]="3" nzRequired>{{'ALLAGAN_REPORTS.Source' | translate}}</nz-form-label>
          <nz-form-control [nzSpan]="10">
            <nz-select formControlName="source" [nzDisabled]="!!modificationId">
              <nz-option *ngFor="let source of sources" [nzValue]="source.key" [nzLabel]="('ALLAGAN_REPORTS.SOURCE.' + source.value) | translate"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item *ngIf="needsItem(source)">
          <nz-form-label [nzSpan]="3" nzRequired>{{'COMMON.Item' | translate}}</nz-form-label>
          <nz-form-control [nzSpan]="10">
            <input

              formControlName="item"
              (input)="itemInput$.next($event.target?.value)"
              [nzAutocomplete]="auto"
              [placeholder]="'RECIPE_FINDER.Placeholder' | translate"
              nz-input
            />
            <nz-autocomplete #auto nzBackfill>
              <nz-auto-option *ngFor="let option of itemCompletion$ | async" [nzValue]="option.name | i18n">
                {{ option.name | i18n }}
              </nz-auto-option>
            </nz-autocomplete>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item *ngIf="source === AllaganReportSource.INSTANCE">
          <nz-form-label [nzSpan]="3" nzRequired>{{'COMMON.Instance' | translate}}</nz-form-label>
          <nz-form-control [nzSpan]="10">
            <input

              formControlName="instance"
              (input)="instanceInput$.next($event.target?.value)"
              [nzAutocomplete]="auto"
              [placeholder]="'ALLAGAN_REPORTS.Instance_placeholder' | translate"
              nz-input
            />
            <nz-autocomplete #auto nzBackfill>
              <nz-auto-option *ngFor="let option of instanceCompletion$ | async" [nzValue]="option.name | i18n">
                {{ option.name | i18n }}
              </nz-auto-option>
            </nz-autocomplete>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item *ngIf="source === AllaganReportSource.VENTURE">
          <nz-form-label [nzSpan]="3" nzRequired>{{'COMMON.Venture' | translate}}</nz-form-label>
          <nz-form-control [nzSpan]="10">
            <input

              formControlName="venture"
              (input)="ventureInput$.next($event.target?.value)"
              [nzAutocomplete]="auto"
              [placeholder]="'ALLAGAN_REPORTS.Venture_placeholder' | translate"
              nz-input
            />
            <nz-autocomplete #auto nzBackfill>
              <nz-auto-option *ngFor="let option of ventureCompletion$ | async" [nzValue]="option.name | i18n">
                {{ option.name | i18n }}
              </nz-auto-option>
            </nz-autocomplete>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item *ngIf="source === AllaganReportSource.DROP">
          <nz-form-label [nzSpan]="3" nzRequired>{{'COMMON.Monster' | translate}}</nz-form-label>
          <nz-form-control [nzSpan]="10">
            <input

              formControlName="mob"
              (input)="mobInput$.next($event.target?.value)"
              [nzAutocomplete]="auto"
              [placeholder]="'ALLAGAN_REPORTS.Monster_placeholder' | translate"
              nz-input
            />
            <nz-autocomplete #auto nzBackfill>
              <nz-auto-option *ngFor="let option of mobCompletion$ | async" [nzValue]="option.name | i18n">
                {{ option.name | i18n }}
              </nz-auto-option>
            </nz-autocomplete>
          </nz-form-control>
        </nz-form-item>
        <ng-container *ngIf="source === AllaganReportSource.VOYAGE">
          <nz-form-item>
            <nz-form-label [nzSpan]="3" nzRequired>{{'ALLAGAN_REPORTS.Voyage_type' | translate}}</nz-form-label>
            <nz-form-control [nzSpan]="10">
              <nz-select formControlName="voyageType">
                <nz-option [nzValue]="0" [nzLabel]="'COMMON.Airship' | translate"></nz-option>
                <nz-option [nzValue]="1" [nzLabel]="'COMMON.Submarine' | translate"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label [nzSpan]="3" nzRequired>{{'COMMON.Voyage' | translate}}</nz-form-label>
            <nz-form-control [nzSpan]="10">
              <input

                formControlName="voyage"
                (input)="voyageInput$.next($event.target?.value)"
                [nzAutocomplete]="auto"
                [placeholder]="'ALLAGAN_REPORTS.Voyage_placeholder' | translate"
                nz-input
              />
              <nz-autocomplete #auto nzBackfill>
                <nz-auto-option *ngFor="let option of voyageCompletion$ | async" [nzValue]="option.name | i18n">
                  {{ option.name | i18n }}
                </nz-auto-option>
              </nz-autocomplete>
            </nz-form-control>
          </nz-form-item>
        </ng-container>
        <ng-container *ngIf="source === AllaganReportSource.FISHING">
          <nz-form-item>
            <nz-form-label [nzSpan]="3" nzRequired>{{'SEARCH_TYPES.Fishing-spot' | translate}}</nz-form-label>
            <nz-form-control [nzSpan]="10">
              <nz-select formControlName="spot"  [nzDisabled]="!!modificationId">
                <nz-option *ngFor="let spot of details.spots" [nzValue]="spot"
                           nzLabel="{{spot.mapId | mapName | i18n}} - {{spot.placeId | placeName | i18n}}"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
          <ng-container *ngIf="fishingSpot$ | async as fishingSpot">
            <nz-form-item>
              <nz-form-label [nzSpan]="3">{{'DB.FISH.OVERLAY.Hookset' | translate}}</nz-form-label>
              <nz-form-control [nzSpan]="10">
                <nz-select formControlName="hookset">
                  <nz-option *ngFor="let entry of hooksets" [nzValue]="entry.key" [nzLabel]="entry.value | actionName | i18n"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label [nzSpan]="3" nzRequired>{{'DB.FISH.OVERLAY.Tug' | translate}}</nz-form-label>
              <nz-form-control [nzSpan]="10">
                <nz-select formControlName="tug" nzShowSearch>
                  <nz-option *ngFor="let entry of tugs" [nzValue]="entry.key" [nzLabel]="entry.key | tugName | translate"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label [nzSpan]="3" nzRequired>{{'DB.FISH.OVERLAY.Bait' | translate}}</nz-form-label>
              <nz-form-control [nzSpan]="10">
                <nz-select formControlName="bait" nzShowSearch>
                  <nz-option *ngFor="let bait of possibleBaits$ | async" [nzValue]="bait" [nzLabel]="bait | itemName | i18n"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label [nzSpan]="3">{{'ALLAGAN_REPORTS.Spawn' | translate}}</nz-form-label>
              <nz-form-control [nzSpan]="10">
                <nz-input-group class="spawn-input" nzAddOnAfter=":00">
                  <nz-input-number [nzMax]="SPAWN_VALIDATOR.max" [nzMin]="SPAWN_VALIDATOR.min" [nzStep]="1" class="input-number-with-addon"
                                   formControlName="spawn"></nz-input-number>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label [nzSpan]="3" [nzRequired]="form.getRawValue()?.spawn !== null">{{'ALLAGAN_REPORTS.Duration' | translate}}</nz-form-label>
              <nz-form-control [nzSpan]="10">
                <nz-input-number [nzMax]="DURATION_VALIDATOR.max" [nzMin]="DURATION_VALIDATOR.min"
                                 formControlName="duration">
                </nz-input-number>
              </nz-form-control>
            </nz-form-item>
            <ng-container *ngIf="mapWeathers$ | async as mapWeathers">
              <nz-form-item>
                <nz-form-label [nzSpan]="3">{{'ALARMS.CUSTOM.Weather' | translate}}</nz-form-label>
                <nz-form-control [nzSpan]="10">
                  <nz-select formControlName="weathers" nzAllowClear nzMode="multiple">
                    <nz-option *ngFor="let weather of mapWeathers" [nzLabel]="weather | weatherName | i18n"
                               [nzValue]="weather"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label [nzSpan]="3">{{'ALARMS.CUSTOM.Weather_from' | translate}}</nz-form-label>
                <nz-form-control [nzSpan]="10">
                  <nz-select formControlName="weathersFrom" nzAllowClear nzMode="multiple">
                    <nz-option *ngFor="let weather of mapWeathers" [nzLabel]="weather | weatherName | i18n"
                               [nzValue]="weather"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </ng-container>
            <nz-form-item>
              <nz-form-label [nzSpan]="3">{{'ALLAGAN_REPORTS.Predator' | translate}}</nz-form-label>
              <nz-form-control [nzSpan]="10" [nzExtra]="'ALLAGAN_REPORTS.Predator_explain' | translate">
                <app-predators-input formControlName="predators" [fishingSpot]="fishingSpot"></app-predators-input>
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <nz-form-label [nzSpan]="3">{{'GATHERING_LOCATIONS.Snagging' | translate}}</nz-form-label>
              <nz-form-control [nzSpan]="10">
                <input formControlName="snagging" type="checkbox">
              </nz-form-control>
            </nz-form-item>
          </ng-container>
        </ng-container>
        <button nz-button nzType="primary" type="submit" [disabled]="form.invalid">
          <span *ngIf="!modificationId">{{'ALLAGAN_REPORTS.Submit_new_report' | translate}}</span>
          <span *ngIf="modificationId">{{'ALLAGAN_REPORTS.Submit_modification_suggestion' | translate}}</span>
        </button>
      </form>
    </div>
  </ng-container>
</ng-container>
