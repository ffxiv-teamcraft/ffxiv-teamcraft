<div fxLayout="row" fxLayoutGap="10px" *ngIf="rotation$ | async as rotation">
  <div class="buttons" fxLayout="column" fxLayoutGap="5px">
    <!--TODO-->
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Save_as_new' | translate">
      <i nz-icon type="copy"></i>
    </button>
    <button nz-button *ngIf="(permissionLevel$ | async) >= 30" nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Persist' | translate" (click)="saveRotation(rotation)">
      <i nz-icon type="save"></i>
    </button>
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Convert_rotation' | translate">
      <i nz-icon type="redo"></i>
    </button>
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip [nzTitle]="'SIMULATOR.Reset' | translate">
      <i nz-icon type="reload"></i>
    </button>
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Import_from_crafting_optimizer' | translate">
      <i nz-icon type="download"></i>
    </button>
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Export_crafting_optimizer' | translate">
      <i nz-icon type="upload"></i>
    </button>
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Import_macro' | translate">
      <i nz-icon type="select"></i>
    </button>
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Generate_ingame_macro' | translate">
      <span class="text-icon">XIV</span>
    </button>
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Min_stats' | translate">
      <i nz-icon type="safety-certificate"></i>
    </button>
    <button disabled nz-button nzType="primary" nzShape="circle" nz-tooltip
            [nzTitle]="'SIMULATOR.Step_by_step_report' | translate">
      <i nz-icon type="ordered-list"></i>
    </button>
  </div>
  <div fxLayout="column" fxLayoutGap="10px" fxFlex="1 1 auto">
    <div fxLayout="row" fxLayoutGap="5px">
      <p>TODO Rotation name</p>
      <button nz-button>TODO rename</button>
      <button nz-button>TODO change rotation</button>
    </div>
    <nz-collapse>
      <nz-collapse-panel [nzHeader]="'SIMULATOR.Configuration' | translate" [nzActive]="custom">
        <div nz-row [nzGutter]="16">
          <div nz-col [nzXs]="24" [nzMd]="custom?12:8">
            <h3>{{'SIMULATOR.CONFIGURATION.Job' | translate}}</h3>
            <nz-select [nzDisabled]="!custom" [ngModel]="(stats$ | async)?.jobId"
                       (ngModelChange)="customJob$.next($event)" class="job-selector">
              <nz-option *ngFor="let job of [8,9,10,11,12,13,14,15]" [nzValue]="job"
                         [nzLabel]="job | jobAbbr | i18n" nzCustomContent>
                <img src="https://garlandtools.org/db/images/{{(job | jobAbbr)?.en}}.png" alt="" class="job-icon">
                {{job | jobAbbr | i18n}}
              </nz-option>
            </nz-select>
            <nz-alert nzType="warning" nzShowIcon *ngIf="(stats$ | async)?.craftsmanship === 0"
                      [nzMessage]="'SIMULATOR.CONFIGURATION.Job_not_configured' | translate">
            </nz-alert>
            <form [formGroup]="statsForm" (ngSubmit)="applyStats()" *ngIf="bonuses$ | async as bonuses"
                  fxLayout="column"
                  fxLayoutAlign="space-between">
              <div fxLayout="row" fxLayoutGap="5px" fxLayoutAlign="space-evenly center">
                <nz-form-item>
                  <nz-form-label nzRequired nzFor="craftsmanship">{{'SIMULATOR.CONFIGURATION.Craftsmanship' |
                    translate}}
                  </nz-form-label>
                  <nz-form-control>
                    <nz-input-group nzAddOnAfter="+{{bonuses.craftsmanship}}">
                      <nz-input-number class="input-number-with-addon" [nzMin]="0" id="craftsmanship"
                                       formControlName="craftsmanship"></nz-input-number>
                    </nz-input-group>
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label nzRequired nzFor="control">{{'SIMULATOR.CONFIGURATION.Control' | translate}}
                  </nz-form-label>
                  <nz-form-control>
                    <nz-input-group nzAddOnAfter="+{{bonuses.control}}">
                      <nz-input-number class="input-number-with-addon" [nzMin]="0" id="control"
                                       formControlName="control"></nz-input-number>
                    </nz-input-group>
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label nzRequired nzFor="cp">{{'SIMULATOR.Cp_amount' | translate}}</nz-form-label>
                  <nz-form-control>
                    <nz-input-group nzAddOnAfter="+{{bonuses.cp}}">
                      <nz-input-number class="input-number-with-addon" [nzMin]="0" id="cp"
                                       formControlName="cp"></nz-input-number>
                    </nz-input-group>
                  </nz-form-control>
                </nz-form-item>
              </div>
              <div fxLayout="row" fxLayoutGap="5px" fxLayoutAlign="space-evenly center">
                <nz-form-item>
                  <nz-form-label nzRequired nzFor="level">{{'SIMULATOR.Level' | translate}}</nz-form-label>
                  <nz-form-control>
                    <nz-input-number [nzMin]="0" id="level" formControlName="level"></nz-input-number>
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-control>
                    <label nz-checkbox id="specialist" formControlName="specialist">{{'SIMULATOR.CONFIGURATION.Specialist'
                      | translate}}</label>
                  </nz-form-control>
                </nz-form-item>
              </div>
              <div fxLayout="column" fxLayoutGap="5px">
                <button nz-button nzType="primary" nzBlock type="submit">
                  {{'SIMULATOR.CONFIGURATION.Apply_stats' | translate}}
                </button>
                <button nz-button nzBlock (click)="saveSet()" [disabled]="!statsForm.dirty">
                  {{'SIMULATOR.CONFIGURATION.Save_on_profile' | translate}}
                </button>
              </div>
            </form>
          </div>
          <div nz-col [nzXs]="24" [nzMd]="8" *ngIf="!custom">
            {{'SIMULATOR.CONFIGURATION.Ingredients' | translate}}<br>
            TODO Ingredients
            <form>
              <button nz-button nzType="primary" nzBlock type="submit">
                {{'SIMULATOR.CONFIGURATION.Apply_ingredients' | translate}}
              </button>
            </form>
          </div>
          <div nz-col [nzXs]="24" [nzMd]="custom?12:8" *ngIf="crafterStats$ | async as crafterStats">
            <h3>{{'SIMULATOR.CONFIGURATION.Consumables' | translate}}</h3>
            <div nz-row [nzGutter]="10" nzAllowClear>
              <div nz-col [nzXs]="12" fxLayout="column" fxLayoutGap="10px" class="consumable-col">
                <nz-select [(ngModel)]="selectedFood" [nzPlaceHolder]="'SIMULATOR.CONFIGURATION.Food' | translate"
                           nzAllowClear>
                  <nz-option *ngFor="let food of foods" [nzValue]="food"
                             nzLabel="{{food.itemId | itemName | i18n}} {{food.hq?'(HQ)':''}}">
                  </nz-option>
                </nz-select>
                <div *ngIf="selectedFood !== undefined && selectedFood !== null; else noFood">
                  <div>
                    <b>{{selectedFood.itemId | itemName | i18n}}</b>
                    <img src="./assets/icons/HQ.png" alt="(HQ)" *ngIf="selectedFood.hq">
                  </div>
                  <div *ngFor="let bonus of selectedFood.bonuses">
                    {{('SIMULATOR.CONFIGURATION.STATS.'+bonus.type) | translate}}: {{bonus.value * 100}}%
                    ({{bonus.max}})
                  </div>
                </div>
                <ng-template #noFood>
                  <div class="nothing-selected">
                    {{'SIMULATOR.CONFIGURATION.No_food' | translate}}
                  </div>
                </ng-template>
              </div>
              <div nz-col [nzXs]="12" fxLayout="column" fxLayoutGap="10px" class="consumable-col">
                <nz-select [(ngModel)]="selectedMedicine"
                           [nzPlaceHolder]="'SIMULATOR.CONFIGURATION.Medicine' | translate" nzAllowClear>
                  <nz-option *ngFor="let medicine of medicines" [nzValue]="medicine"
                             nzLabel="{{medicine.itemId | itemName | i18n}} {{medicine.hq?'(HQ)':''}}">
                  </nz-option>
                </nz-select>
                <div *ngIf="selectedMedicine !== undefined && selectedMedicine !== null; else noMedicine">
                  <div>
                    <b>{{selectedMedicine.itemId | itemName | i18n}}</b>
                    <img src="./assets/icons/HQ.png" alt="(HQ)" *ngIf="selectedMedicine.hq">
                  </div>
                  <div *ngFor="let bonus of selectedMedicine.bonuses">
                    {{('SIMULATOR.CONFIGURATION.STATS.'+bonus.type) | translate}}: {{bonus.value * 100}}%
                    ({{bonus.max}})
                  </div>
                </div>
                <ng-template #noMedicine>
                  <div class="nothing-selected">
                    {{'SIMULATOR.CONFIGURATION.No_medicine' | translate}}
                  </div>
                </ng-template>
              </div>
              <div nz-col [nzXs]="24" fxLayout="column" fxLayoutGap="10px" class="consumable-col">
                <nz-select [(ngModel)]="selectedFreeCompanyActions" nzMode="multiple"
                           [nzPlaceHolder]="'SIMULATOR.CONFIGURATION.Action' | translate" nzAllowClear>
                  <nz-option-group [nzLabel]="('SIMULATOR.CONFIGURATION.'+type) | translate"
                                   *ngFor="let type of ['Control', 'Craftsmanship']">
                    <nz-option *ngFor="let action of getFreeCompanyActions(type)" [nzValue]="action"
                               [nzLabel]="action.actionId | freeCompanyActionName | i18n"
                               [nzDisabled]="isFreeCompanyActionOptionDisabled(type, action.actionId)"></nz-option>
                  </nz-option-group>
                </nz-select>
                <div *ngIf="selectedFreeCompanyActions.length > 0; else noFcBuffs">
                  <div *ngFor="let action of selectedFreeCompanyActions">
                    <div>
                      <b>{{action.actionId | freeCompanyActionName | i18n}}</b>
                    </div>
                    <div>
                      {{('SIMULATOR.CONFIGURATION.STATS.'+action.type) | translate}}: {{action.value}}
                    </div>
                  </div>
                </div>
                <ng-template #noFcBuffs>
                  <div class="nothing-selected">
                    {{'SIMULATOR.CONFIGURATION.No_fc_buffs' | translate}}
                  </div>
                </ng-template>
              </div>
            </div>
            <div fxLayout="column" fxLayoutGap="5px">
              <button nz-button nzType="primary" nzBlock (click)="applyConsumables(crafterStats)">
                {{'SIMULATOR.CONFIGURATION.Apply_foods' | translate}}
              </button>
              <button nz-button nzBlock (click)="saveDefaultConsumables()">
                {{'SIMULATOR.CONFIGURATION.Save_consumables' | translate}}
              </button>
            </div>
          </div>
        </div>
      </nz-collapse-panel>
    </nz-collapse>

    <div fxLayout="column" fxLayoutGap="10px" *ngIf="result$ | async as resultData">
      <nz-card>
        <div class="card-header" fxLayout="row" fxLayoutAlign="space-between center">
          <div fxLayout="row" fxLayoutGap="10px" *ngIf="!custom">
            <div class="avatar">
              <app-item-icon [icon]="item.icon" [width]="42"></app-item-icon>
            </div>
            <div fxLayout="column">
              <div>{{item.id | itemName | i18n}}</div>
              <div>{{resultData.simulation.recipe.lvl}} {{getStars(resultData.simulation.recipe.stars)}}</div>
            </div>
          </div>
          <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="center center">
            <div>{{resultData.simulation.crafterStats.jobId | jobName | i18n}}</div>
            <div fxLayout="column">
              <div>{{'SIMULATOR.CONFIGURATION.Craftsmanship' | translate}}:
                {{resultData.simulation.crafterStats.craftsmanship}}
              </div>
              <div>{{'SIMULATOR.CONFIGURATION.Control' | translate}}: {{resultData.simulation.crafterStats._control}}
              </div>
            </div>
          </div>
          <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="center center">
            <div>
              {{'SIMULATOR.Step_counter' | translate}}
              <nz-input-number [nzDisabled]="!snapshotMode"
                               class="stap-counter"
                               [ngModel]="resultData.simulation.steps.length"
                               [nzMax]="resultData.simulation.steps.length"
                               [nzMin]="0"
                               [nzStep]="1"
                               (ngModelChange)="snapshotStep$.next($event)"></nz-input-number>
              <button nz-button
                      (click)="snapshotMode = !snapshotMode; snapshotMode === false?snapshotStep$.next(9999):null"
                      [nzType]="snapshotMode?'primary':'default'"
                      nz-tooltip [nzTitle]="'SIMULATOR.Toggle_snapshot_mode' | translate">
                <i nz-icon [iconfont]="'icon-debug'"></i>
              </button>
            </div>
          </div>
        </div>
        <div fxLayout="row" fxLayoutGap="10px">
          <div class="durability" fxLayout="column" fxLayoutAlign="center center">
            <h3>{{'SIMULATOR.Durability' | translate}}</h3>
            <span class="durability-value">{{resultData.simulation.durability}} / {{resultData.simulation.recipe.durability}}</span>
          </div>
          <div class="craft-bars" fxFlex="1 1 auto" fxLayout="column" fxLayoutGap="10px">
            <div class="top-bars">
              <div fxLayout="column">
                <h3>{{'SIMULATOR.Progress' | translate}}</h3>
                <nz-progress
                  [nzPercent]="barPercent(resultData.simulation.progression,resultData.simulation.recipe.progress)"
                  class="progress-progressbar"
                  [nzFormat]="barFormat(resultData.simulation.progression,resultData.simulation.recipe.progress)"></nz-progress>
              </div>
              <div fxLayout="column">
                <h3>{{'SIMULATOR.Quality' | translate}}</h3>
                <!--TODO thresholds-->
                <nz-progress
                  [nzPercent]="barPercent(resultData.simulation.quality,resultData.simulation.recipe.quality)"
                  [nzFormat]="barFormat(resultData.simulation.quality,resultData.simulation.recipe.quality)"></nz-progress>
              </div>
            </div>
            <div fxLayout="row" fxLayoutAlign="space-between center">
              <div fxLayout="row" fxLayoutGap="10px" fxFlex="1 1 auto">
                <div class="hq-chances">
                  {{'SIMULATOR.Hq' | translate}}:
                  <span class="hq-chances-value">
                  {{resultData.hqPercent}}%
                </span>
                </div>
                <div class="cp-progress" fxFlex="1 1 300px">
                  <span>{{'SIMULATOR.Cp_amount' | translate}}</span>
                  <nz-progress
                    class="cp-amount"
                    [nzPercent]="100*resultData.simulation.availableCP/resultData.simulation.maxCP"
                    [nzFormat]="barFormat(resultData.simulation.availableCP,resultData.simulation.maxCP)"></nz-progress>
                </div>
              </div>
              <div class="report" *ngIf="report$ | async as report">
                <span class="report-row">
                    {{'SIMULATOR.Reliability' | translate}}: {{report.successPercent}}%
                </span>
                <span class="report-row">
                    {{'SIMULATOR.Average_hq' | translate}}: {{report.averageHQPercent}}%
                </span>
              </div>
            </div>
          </div>
        </div>
      </nz-card>

      <nz-card>
        <div fxLayout="row" fxLayoutGap="px" fxLayoutAlign="flex-starts center" class="buffs-container">
          <div class="buff-container" *ngFor="let buff of resultData.simulation.buffs">
            <span class="stacks" *ngIf="buff.stacks > 0">{{buff.stacks}}</span>
            <img [src]="getBuffIcon(buff)" class="buff-icon" alt="">
            <span class="duration" *ngIf="buff.duration.toString() !== 'Infinity'">{{buff.duration}}</span>
          </div>
        </div>
      </nz-card>

      <nz-card [class.failed]="actionFailed">
        <div fxLayout="row wrap" ngxDroppable="action" fxLayoutGap="10px" class="actions-container ngx-dnd-container"
             (drop)="actionDrop($event)">
          <div *ngFor="let step of resultData.steps;let i = index;" [ngxDraggable]="['action']"
               class="ngx-dnd-item" [model]="step.action" (drag)="removeAction(i)" [moves]="step.action.canBeMoved()">
            <app-action [action]="step.action"
                        [simulation]="resultData.simulation"
                        (actionclick)="removeAction(i)"
                        [disabled]="!step.success || step.skipped"
                        [ignoreDisabled]="true"
                        [cpCost]="step.cpDifference"
                        [failed]="!step.success"></app-action>
          </div>
        </div>
      </nz-card>

      <nz-card>
        <div class="category-row">
          <div>
            <h4>{{'SIMULATOR.CATEGORY.Progression' | translate}}</h4>
            <div class="actions-row ngx-dnd-container" ngxDroppable (drop)="disableEvent($event)" [copy]="true">
              <app-action (actionclick)="addAction(action)" [ngxDraggable]="['action']" [model]="action"
                          class="ngx-dnd-item"
                          [disabled]="!action.canBeUsed(resultData.simulation, true) || snapshotMode
                    || resultData.simulation.success !== undefined"
                          [notEnoughCp]="action.getBaseCPCost(resultData.simulation) > resultData.simulation.availableCP"
                          [action]="action" [simulation]="resultData.simulation"
                          *ngFor="let action of getProgressActions()"
                          (onDragStart)="tooltipsDisabled = true"
                          (onDragEnd)="tooltipsDisabled = false"
                          [tooltipDisabled]="tooltipsDisabled"></app-action>
            </div>
          </div>
          <div>
            <h4>{{'SIMULATOR.CATEGORY.Quality' | translate}}</h4>
            <div class="actions-row ngx-dnd-container" ngxDroppable (drop)="disableEvent($event)" [copy]="true">
              <app-action (actionclick)="addAction(action)" [ngxDraggable]="['action']" [model]="action"
                          class="ngx-dnd-item action-from-bar"
                          [disabled]="!action.canBeUsed(resultData.simulation, true) || snapshotMode
                    || resultData.simulation.success !== undefined"
                          [notEnoughCp]="action.getBaseCPCost(resultData.simulation) > resultData.simulation.availableCP"
                          [action]="action" [simulation]="resultData.simulation"
                          *ngFor="let action of getQualityActions()"
                          (onDragStart)="tooltipsDisabled = true"
                          (onDragEnd)="tooltipsDisabled = false"
                          [tooltipDisabled]="tooltipsDisabled"></app-action>
            </div>
          </div>
        </div>
        <div class="category-row">
          <div>
            <h4>{{'SIMULATOR.CATEGORY.Cp_recovery' | translate}}</h4>
            <div class="actions-row ngx-dnd-container" ngxDroppable (drop)="disableEvent($event)" [copy]="true">
              <app-action (actionclick)="addAction(action)" [ngxDraggable]="['action']" [model]="action"
                          class="ngx-dnd-item action-from-bar"
                          [disabled]="!action.canBeUsed(resultData.simulation, true) || snapshotMode
                    || resultData.simulation.success !== undefined"
                          [notEnoughCp]="action.getBaseCPCost(resultData.simulation) > resultData.simulation.availableCP"
                          [action]="action" [simulation]="resultData.simulation"
                          *ngFor="let action of getCpRecoveryActions()"
                          (onDragStart)="tooltipsDisabled = true"
                          (onDragEnd)="tooltipsDisabled = false"
                          [tooltipDisabled]="tooltipsDisabled"></app-action>
            </div>
          </div>
          <div>
            <h4>{{'SIMULATOR.CATEGORY.Buff' | translate}}</h4>
            <div class="actions-row ngx-dnd-container" ngxDroppable (drop)="disableEvent($event)" [copy]="true">
              <app-action (actionclick)="addAction(action)" [ngxDraggable]="['action']" [model]="action"
                          class="ngx-dnd-item action-from-bar"
                          [disabled]="!action.canBeUsed(resultData.simulation, true) || snapshotMode
                    || resultData.simulation.success !== undefined"
                          [notEnoughCp]="action.getBaseCPCost(resultData.simulation) > resultData.simulation.availableCP"
                          [action]="action" [simulation]="resultData.simulation"
                          *ngFor="let action of getBuffActions()"
                          (onDragStart)="tooltipsDisabled = true"
                          (onDragEnd)="tooltipsDisabled = false"
                          [tooltipDisabled]="tooltipsDisabled"></app-action>
            </div>
          </div>
        </div>
        <div class="category-row">
          <div>
            <h4>{{'SIMULATOR.CATEGORY.Repair' | translate}}</h4>
            <div class="actions-row ngx-dnd-container" ngxDroppable (drop)="disableEvent($event)" [copy]="true">
              <app-action (actionclick)="addAction(action)" [ngxDraggable]="['action']" [model]="action"
                          class="ngx-dnd-item action-from-bar"
                          [disabled]="!action.canBeUsed(resultData.simulation, true) || snapshotMode
                    || resultData.simulation.success !== undefined"
                          [notEnoughCp]="action.getBaseCPCost(resultData.simulation) > resultData.simulation.availableCP"
                          [action]="action" [simulation]="resultData.simulation"
                          *ngFor="let action of getRepairActions()"
                          (onDragStart)="tooltipsDisabled = true"
                          (onDragEnd)="tooltipsDisabled = false"
                          [tooltipDisabled]="tooltipsDisabled"></app-action>
            </div>
          </div>
          <div>
            <h4>{{'SIMULATOR.CATEGORY.Specialty' | translate}}</h4>
            <div class="actions-row ngx-dnd-container" ngxDroppable (drop)="disableEvent($event)" [copy]="true">
              <app-action (actionclick)="addAction(action)" [ngxDraggable]="['action']" [model]="action"
                          class="ngx-dnd-item action-from-bar"
                          [disabled]="!action.canBeUsed(resultData.simulation, true) || snapshotMode
                    || resultData.simulation.success !== undefined"
                          [notEnoughCp]="action.getBaseCPCost(resultData.simulation) > resultData.simulation.availableCP"
                          [action]="action" [simulation]="resultData.simulation"
                          *ngFor="let action of getSpecialtyActions()"
                          (onDragStart)="tooltipsDisabled = true"
                          (onDragEnd)="tooltipsDisabled = false"
                          [tooltipDisabled]="tooltipsDisabled"></app-action>
            </div>
          </div>
          <div>
            <h4>{{'SIMULATOR.CATEGORY.Other' | translate}}</h4>
            <div class="actions-row ngx-dnd-container" ngxDroppable (drop)="disableEvent($event)" [copy]="true">
              <app-action (actionclick)="addAction(action)" [ngxDraggable]="['action']" [model]="action"
                          class="ngx-dnd-item action-from-bar"
                          [disabled]="!action.canBeUsed(resultData.simulation, true) || snapshotMode
                    || resultData.simulation.success !== undefined"
                          [notEnoughCp]="action.getBaseCPCost(resultData.simulation) > resultData.simulation.availableCP"
                          [action]="action" [simulation]="resultData.simulation"
                          *ngFor="let action of getOtherActions()"
                          (onDragStart)="tooltipsDisabled = true"
                          (onDragEnd)="tooltipsDisabled = false"
                          [tooltipDisabled]="tooltipsDisabled"></app-action>
            </div>
          </div>
        </div>
      </nz-card>
    </div>
  </div>
</div>
