<app-page-loader *ngIf="loading$ | async; else pageContent">
</app-page-loader>
<ng-template #pageContent>
  <div *ngIf="display$ | async as display">
    <div class="toolbar" fxLayout="row wrap" fxLayoutGap="5px">
      <button nz-button [nzShape]="'circle'" [nzType]="'primary'" (click)="createCustomItem()" nz-tooltip
              [nzTitle]="'CUSTOM_ITEMS.New_item' | translate">
        <i nz-icon type="file-add"></i>
      </button>
      <button nz-button [nzShape]="'circle'" [nzType]="'primary'" (click)="createFolder()" nz-tooltip
              [nzTitle]="'CUSTOM_ITEMS.New_folder' | translate">
        <i nz-icon type="folder-add"></i>
      </button>
      <button nz-button [nzShape]="'circle'" [nzType]="'primary'" nz-tooltip (click)="importItems()"
              [nzTitle]="'CUSTOM_ITEMS.Import_items' | translate">
        <i nz-icon type="download"></i>
      </button>
    </div>

    <div *ngIf="display.otherItems.length === 0 && display.folders.length === 0; else itemsDisplay">
      <app-fullpage-message height="300px">{{'CUSTOM_ITEMS.No_items' | translate}}</app-fullpage-message>
    </div>
    <ng-template #itemsDisplay>
      <div fxLayout="column" fxLayoutGap="20px">
        <div class="ngx-dnd-container" ngxDroppable="item"
             fxLayout="column" fxLayoutGap="10px"
             (drop)="setItemIndex($event.value, $event.dropIndex, display.otherItems, undefined)">
          <div class="ngx-dnd-item" *ngFor="let item of display.otherItems; trackBy: trackByKey"
               ngxDraggable="item"
               [model]="item">
            <ng-container *ngTemplateOutlet="itemDisplay;context:{$implicit: item}"></ng-container>
          </div>
        </div>
        <div fxLayout="column" fxLayoutGap="10px">
          <div class="ngx-dnd-container" ngxDroppable="folder"
               fxLayout="column" fxLayoutGap="10px"
               (drop)="setFolderIndex($event.value, $event.dropIndex, display.folders)">
            <div class="ngx-dnd-item" *ngFor="let folderDisplay of display.folders; trackBy: trackByFolderKey"
                 ngxDraggable="folder"
                 [model]="folderDisplay.folder">
              <nz-collapse>
                <nz-collapse-panel [nzHeader]="folderHeader">
                  <ng-template #folderHeader>
                    <div fxLayout="row" fxLayoutAlign="space-between center">
                      <div fxLayout="row" fxLayoutAlign="flex-start center" fxLayoutGap="5px">
                        <i nz-icon type="folder"></i>
                        <div>{{folderDisplay.folder.name}}</div>
                      </div>
                      <div class="buttons" fxLayout="row" fxLayoutAlign="center" fxLayoutGap="5px">
                        <button nz-button nz-popconfirm [nzTitle]="'Confirm' | translate"
                                nzShape="circle"
                                nzType="danger"
                                (nzOnConfirm)="deleteCustomItemFolder(folderDisplay.folder.$key)">
                          <i nz-icon type="delete"></i>
                        </button>
                      </div>
                    </div>
                  </ng-template>
                  <div class="ngx-dnd-container folder-items-container" ngxDroppable="item"
                       fxLayout="column" fxLayoutGap="10px"
                       (drop)="setItemIndex($event.value, $event.dropIndex, display.otherItems, folderDisplay.folder.$key)">
                    <div class="ngx-dnd-item" *ngFor="let item of folderDisplay.items; trackBy: trackByKey"
                         ngxDraggable="item"
                         [model]="item">
                      <ng-container *ngTemplateOutlet="itemDisplay;context:{$implicit: item}"></ng-container>
                    </div>
                  </div>
                </nz-collapse-panel>
              </nz-collapse>
            </div>
          </div>

        </div>
      </div>
    </ng-template>
  </div>
</ng-template>

<ng-template #itemDisplay let-item>
  <nz-collapse>
    <nz-collapse-panel [nzHeader]="header">
      <ng-template #header>
        <div fxLayout="row" fxLayoutAlign="space-between center">
          <div>{{item.name}}</div>
          <div class="buttons" fxLayout="row" fxLayoutAlign="center" fxLayoutGap="5px">
            <button nz-button nz-popconfirm [nzTitle]="'Confirm' | translate"
                    nzShape="circle"
                    nzType="danger"
                    (nzOnConfirm)="deleteCustomItem(item.$key)">
              <i nz-icon type="delete"></i>
            </button>
          </div>
        </div>
      </ng-template>
      <div class="item-form" fxLayout="column" fxLayoutGap="5px">
        <div fxLayout="row" fxLayoutAlign="flex-start center" fxLayoutGap="5px">
          <div>{{'CUSTOM_ITEMS.Details' | translate}}</div>
          <div>
            <nz-dropdown [nzTrigger]="'click'" nz-tooltip [nzTitle]="'CUSTOM_ITEMS.Add_details' | translate">
              <button nz-dropdown nz-button nzShape="circle" nzSize="small">
                <i nz-icon type="plus"></i>
              </button>
              <ul nz-menu>
                <li nz-menu-item
                    (click)="addGathering(item)">{{'CUSTOM_ITEMS.DETAILS.GATHERING.Title' | translate}}</li>
              </ul>
            </nz-dropdown>
          </div>
        </div>
        <div *ngIf="item.gatheredBy !== undefined" fxFlex="column">
          <nz-divider [nzText]="'CUSTOM_ITEMS.DETAILS.GATHERING.Title' | translate" nzOrientation="left"></nz-divider>
          <div fxLayout="row" fxLayoutGap="5px" fxLayout.lt-sm="column">
            <nz-form-item>
              <nz-form-label
              >{{'CUSTOM_ITEMS.DETAILS.GATHERING.Type' | translate}}</nz-form-label>
              <nz-form-control>
                <nz-select [(ngModel)]="item.gatheredBy.type">
                  <nz-option [nzValue]="0" [nzLabel]="('ALARMS.CUSTOM.TYPE.'+(0 | nodeTypeName)) | translate">
                  </nz-option>
                  <nz-option [nzValue]="1" [nzLabel]="('ALARMS.CUSTOM.TYPE.'+(1 | nodeTypeName)) | translate">
                  </nz-option>
                  <nz-option [nzValue]="2" [nzLabel]="('ALARMS.CUSTOM.TYPE.'+(2 | nodeTypeName)) | translate">
                  </nz-option>
                  <nz-option [nzValue]="3" [nzLabel]="('ALARMS.CUSTOM.TYPE.'+(3 | nodeTypeName)) | translate">
                  </nz-option>
                  <nz-option [nzValue]="4" [nzLabel]="('ALARMS.CUSTOM.TYPE.'+(4 | nodeTypeName)) | translate">
                  </nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label nzRequired
                             nzFor="level">{{'CUSTOM_ITEMS.DETAILS.Level' | translate}}</nz-form-label>
              <nz-form-control>
                <nz-input-number [(ngModel)]="item.gatheredBy.level" [nzMin]="1" [nzStep]="1"></nz-input-number>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label
              >{{'CUSTOM_ITEMS.DETAILS.GATHERING.Stars' | translate}}</nz-form-label>
              <nz-form-control>
                <nz-select [(ngModel)]="item.gatheredBy.stars_tooltip">
                  <nz-option [nzValue]="''" [nzLabel]="'CUSTOM_ITEMS.DETAILS.None' | translate">
                  </nz-option>
                  <nz-option [nzValue]="'★'" [nzLabel]="'★'">
                  </nz-option>
                  <nz-option [nzValue]="'★★'" [nzLabel]="'★★'">
                  </nz-option>
                  <nz-option [nzValue]="'★★★'" [nzLabel]="'★★★'">
                  </nz-option>
                  <nz-option [nzValue]="'★★★★'" [nzLabel]="'★★★★'">
                  </nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label>{{'ALARMS.CUSTOM.Map' | translate}}</nz-form-label>
              <nz-form-control>
                <nz-select [(ngModel)]="item.gatheredBy.nodes[0].mapid" *ngIf="maps$ | async as maps; else loading"
                           nzAllowClear nzShowSearch class="maps-select">
                  <nz-option *ngFor="let map of maps" [nzLabel]="map.PlaceName | xivapiI18n"
                             [nzValue]="map.ID"></nz-option>
                </nz-select>
                <ng-template #loading>
                  <nz-spin></nz-spin>
                </ng-template>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label>X</nz-form-label>
              <nz-form-control>
                <nz-input-number [nzMin]="0" [(ngModel)]="item.gatheredBy.nodes[0].coords[0]"></nz-input-number>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label>Y</nz-form-label>
              <nz-form-control>
                <nz-input-number [nzMin]="0" [(ngModel)]="item.gatheredBy.nodes[0].coords[1]"></nz-input-number>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
        <button nz-button nzBlock nzType="primary" (click)="updateCustomItem(item)">
          {{'CUSTOM_ITEMS.Save' | translate}}
        </button>
      </div>
    </nz-collapse-panel>
  </nz-collapse>
</ng-template>
