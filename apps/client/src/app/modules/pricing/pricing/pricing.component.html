<div *ngIf="list$ | async as list" fxLayout="column" fxLayoutGap="10px">
  <h3>{{list?.name}} - {{"Pricing" | translate}}</h3>

  <div fxLayout="row" fxLayoutAlign="space-between">
    <button (click)="close.emit()" nz-button nzType="primary">
      <i nz-icon nzType="arrow-left"></i>
      {{'Back_to_list' | translate}}
    </button>

    <div fxLayout="row" fxLayoutGap="5px">
      <label [(ngModel)]="settings.expectToSellEverything" (ngModelChange)="updateCosts(list)" nz-checkbox>
        {{'PRICING.Expect_to_sell_everything' | translate}}
      </label>

      <label [(ngModel)]="settings.ignoreCompletedItemInPricing" (ngModelChange)="updateCosts(list)" nz-checkbox>
        {{'PRICING.Ignore_completed_items' | translate}}
      </label>
    </div>
  </div>

  <nz-card>
    <nz-card-meta [nzTitle]="'Spending' | translate"
                  nzDescription="{{spendingTotal | number:'1.0-0'}} gil"></nz-card-meta>
    <nz-collapse *ngIf="list.items.length > 0" class="collapse-container">
      <nz-collapse-panel *ngIf="crystals$ | async as crystals" [nzHeader]="header">
        <ng-template #header>
          <div class="panel-header" fxLayout="row" fxLayoutAlign="space-between center">
            <div>{{'Crystals' | translate}}</div>
            <div fxLayout="row" fxLayoutGap="10px">
              <button (click)="$event.stopPropagation();crystals.length > 10?null:fillMbCosts(crystals)" (nzOnConfirm)="fillMbCosts(crystals)"
                      *ngIf="loggedIn$ | async"
                      [nzPopconfirmTitle]="crystals.length > 10 ? ('PRICING.Autofill_panel_prices_warning' | translate: {time: (crystals.length / 2 | ceil)}) : null"
                      nz-button
                      nz-popconfirm
                      nz-tooltip
                      [nzTooltipTitle]="'PRICING.Autofill_panel_prices' | translate"
                      nzShape="circle">
                <i nzIconfont="icon-dollar" nz-icon></i>
              </button>
              <button (click)="$event.stopPropagation()"
                      [clipboard]="getSpendingText"
                      [clipboardFnArgs]="[crystals, list]"
                      [clipboardSuccessMessage]="'PRICING.Content_copied' | translate"
                      [nzTooltipTitle]="'PRICING.Copy_panel_as_text' | translate"
                      nz-button
                      nz-tooltip nzShape="circle">
                <i nz-icon nzType="copy"></i>
              </button>
            </div>
          </div>
        </ng-template>
        <app-pricing-row (priceChange)="updateCosts(list)" (save)="save(list)"
                         *ngFor="let row of crystals; trackBy: trackByItemFn; let odd = odd" [item]="row"
                         [listId]="list.$key" [odd]="odd"></app-pricing-row>
      </nz-collapse-panel>

      <nz-collapse-panel *ngIf="items$ | async as items" [nzHeader]="header">
        <ng-template #header>
          <div class="panel-header" fxLayout="row" fxLayoutAlign="space-between center">
            <div>{{'Other' | translate}}</div>
            <div fxLayout="row" fxLayoutGap="10px">
              <button (click)="$event.stopPropagation();items.length > 10?null:fillMbCosts(items)" (nzOnConfirm)="fillMbCosts(items)" *ngIf="loggedIn$ | async"
                      [nzPopconfirmTitle]="items.length > 10 ? ('PRICING.Autofill_panel_prices_warning' | translate: {time: (items.length / 2 | ceil)}): null"
                      nz-button
                      nz-popconfirm
                      nz-tooltip
                      [nzTooltipTitle]="'PRICING.Autofill_panel_prices' | translate"
                      nzShape="circle">
                <i nzIconfont="icon-dollar" nz-icon></i>
              </button>
              <button (click)="$event.stopPropagation()"
                      [clipboard]="getSpendingText"
                      [clipboardFnArgs]="[items, list]"
                      [clipboardSuccessMessage]="'PRICING.Content_copied' | translate"
                      [nzTooltipTitle]="'PRICING.Copy_panel_as_text' | translate"
                      nz-button
                      nz-tooltip nzShape="circle">
                <i nz-icon nzType="copy"></i>
              </button>
            </div>
          </div>
        </ng-template>
        <app-pricing-row (priceChange)="updateCosts(list)" (save)="save(list)"
                         *ngFor="let row of items; trackBy: trackByItemFn; let odd = odd" [item]="row"
                         [listId]="list.$key" [odd]="odd"></app-pricing-row>
      </nz-collapse-panel>

      <nz-collapse-panel *ngIf="preCrafts$ | async as preCrafts" [nzHeader]="header">
        <ng-template #header>
          <div class="panel-header" fxLayout="row" fxLayoutAlign="space-between center">
            <div>{{'Pre_crafts' | translate}}</div>
            <div fxLayout="row" fxLayoutGap="10px">
              <button (click)="$event.stopPropagation();preCrafts.length > 10?null:fillMbCosts(preCrafts)" (nzOnConfirm)="fillMbCosts(preCrafts)"
                      *ngIf="loggedIn$ | async"
                      [nzPopconfirmTitle]="preCrafts.length > 10 ? ('PRICING.Autofill_panel_prices_warning' | translate: {time: (preCrafts.length / 2 | ceil)}): null"
                      nz-button
                      nz-popconfirm
                      nz-tooltip
                      [nzTooltipTitle]="'PRICING.Autofill_panel_prices' | translate"
                      nzShape="circle">
                <i nzIconfont="icon-dollar" nz-icon></i>
              </button>
              <button (click)="$event.stopPropagation()"
                      [clipboard]="getSpendingText"
                      [clipboardFnArgs]="[preCrafts, list]"
                      [clipboardSuccessMessage]="'PRICING.Content_copied' | translate"
                      [nzTooltipTitle]="'PRICING.Copy_panel_as_text' | translate"
                      nz-button
                      nz-tooltip nzShape="circle">
                <i nz-icon nzType="copy"></i>
              </button>
            </div>
          </div>
        </ng-template>

        <app-pricing-row (priceChange)="updateCosts(list)" (save)="save(list)"
                         *ngFor="let row of preCrafts; trackBy: trackByItemFn; let odd = odd" [craftCost]="getCraftCost(row)" [item]="row"
                         [listId]="list.$key" [odd]="odd" [preCraft]="true"></app-pricing-row>
      </nz-collapse-panel>
    </nz-collapse>
  </nz-card>

  <nz-card>
    <nz-card-meta [nzDescription]="description"
                  [nzTitle]="title"></nz-card-meta>
    <ng-template #description>
      <div fxLayout="row" fxLayoutAlign="flex-start center" fxLayoutGap="5px">
        <div>{{getTotalEarnings(list.finalItems, list) | number:'1.0-0'}} gil</div>
        <button (click)="setBenefits(list.finalItems, list)" nz-button nzShape="circle" nzSize="small">
          <i nz-icon nzType="edit"></i>
        </button>
      </div>
    </ng-template>
    <ng-template #title>
      <div fxLayout="row" fxLayoutAlign="space-between center">
        <div>{{'Earning' | translate}}</div>
        <button [clipboard]="getEarningText"
                [clipboardFnArgs]="[list.finalItems, list]"
                [clipboardSuccessMessage]="'PRICING.Content_copied' | translate"
                [nzTooltipTitle]="'PRICING.Copy_earnings_as_text' | translate"
                nz-button
                nz-tooltip nzShape="circle">
          <i nz-icon nzType="copy"></i>
        </button>
      </div>
    </ng-template>
    <nz-collapse class="collapse-container">
      <nz-collapse-panel *ngIf="list.finalItems.length > 0" [nzHeader]="header">
        <ng-template #header>
          <div fxLayout="row" fxLayoutAlign="space-between center">
            <div>{{'Items' | translate}}</div>
            <div fxLayout="row" fxLayoutGap="10px">
              <button (click)="$event.stopPropagation();list.finalItems.length > 10?null:fillMbCosts(list.finalItems)"
                      (nzOnConfirm)="fillMbCosts(list.finalItems)"
                      *ngIf="loggedIn$ | async"
                      [nzPopconfirmTitle]="list.finalItems.length > 10 ? ('PRICING.Autofill_panel_prices_warning' | translate: {time: (list.finalItems.length / 2 | ceil)}):null"
                      class="fill-prices-button"
                      nz-button
                      nz-popconfirm>
                {{'PRICING.Autofill_panel_prices' | translate}}
              </button>
              <button (click)="$event.stopPropagation();list.finalItems.length > 10?null:fillMbCosts(list.finalItems, true)"
                      (nzOnConfirm)="fillMbCosts(list.finalItems, true)" *ngIf="loggedIn$ | async"
                      [nzPopconfirmTitle]="list.finalItems.length > 10 ? ('PRICING.Autofill_panel_prices_warning' | translate: {time: (list.finalItems.length / 2 | ceil)}):null"
                      class="fill-prices-button"
                      nz-button
                      nz-popconfirm
                      nzType="primary">
                {{'PRICING.Autofill_panel_prices_your_server' | translate}}
              </button>
            </div>
          </div>
        </ng-template>
        <app-pricing-row (save)="save(list)" *ngFor="let row of list.finalItems; trackBy: trackByItemFn;let odd = odd"
                         [craftCost]="getCraftCost(row)" [earning]="true"
                         [item]="row"
                         [listId]="list.$key" [odd]="odd"></app-pricing-row>
      </nz-collapse-panel>
    </nz-collapse>
  </nz-card>

  <nz-card [nzTitle]="'Discounts' | translate">
    <div fxLayout="row" fxLayoutAlign="flex-start flex-start" fxLayoutGap="10px">
      <nz-input-group [nzAddOnBefore]="'Flat_discount' | translate" nzAddOnAfter="gil">
        <input [(ngModel)]="flatDiscount" (ngModelChange)="saveDiscounts(list.$key)" nz-input type="number"/>
      </nz-input-group>
      <nz-input-group [nzAddOnBefore]="'Percent_discount' | translate" nzAddOnAfter="%">
        <input [(ngModel)]="discount" (ngModelChange)="saveDiscounts(list.$key)" nz-input type="number"/>
      </nz-input-group>
    </div>
  </nz-card>

  <nz-alert *ngIf="getBenefits(list) as benefits" [nzMessage]="message"
            [nzType]="benefits >= 0 ? 'success' : 'error'" class="dark">
    <ng-template #message>
      <div fxLayout="row" fxLayoutAlign="flex-start center" fxLayoutGap="5px">
        <div>{{'Benefits' | translate}}: {{ benefits | number:'1.0-0'}} gil</div>
      </div>
    </ng-template>
  </nz-alert>
</div>
