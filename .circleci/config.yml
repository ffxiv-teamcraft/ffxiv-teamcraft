version: 2
jobs:
    setup:
        docker:
        - image: circleci/node:8.11.3-browsers
        steps:
        - checkout
        - run:
              name: Show current branch
              command: echo ${CIRCLE_BRANCH}
        - restore_cache:
              keys:
              - v1-dependencies-{{ checksum "package.json" }}
              - v1-dependencies-
        - run:
              name: Install local dependencies
              command: npm install
        - save_cache:
              key: v1-dependencies-{{ checksum "package.json" }}
              paths:
              - node_modules


    lint:
        docker:
        - image: circleci/node:8.11.3-browsers
        steps:
        - run:
              name: Lint code and JSON
              command: npm lint


    test:
        docker:
        - image: circleci/node:8.11.3-browsers
        steps:
        - run:
              name: Testing
              command: npm run test
        - run:
              name: Codecov upload
              command: npm run codecov


    build:
        docker:
        - image: circleci/node:8.11.3-browsers
        steps:
        - run:
              name: Building
              command: |
                  if [ "${CIRCLE_BRANCH}" == "master" ]; then
                      npm run build:prod
                  else
                      npm run build:beta
        - save_cache:
              key: dist-{{ .Environment.CIRCLE_BRANCH }}-{{ .Environment.CIRCLE_SHA1 }}
              paths:
              - dist


    deploy-prod:
        docker:
        - image: circleci/node:8.11.3-browsers
        steps:
        - run:
              name: Deploying web
              command: npm run build:prod && firebase deploy -P default
        - run:
              name: Deploying desktop
              command: npm run electron:setup:publish


    deploy-staging:
        docker:
        - image: circleci/node:8.11.3-browsers
        steps:
        - run:
              name: Deploying web
              command: npm run build:beta && firebase deploy -P beta


workflows:
    version: 2
    flow:
        jobs:
        - setup
        - lint:
              requires:
              - setup
        - test:
              requires:
              -setup
        - build:
              requires:
              - lint
              - test
        - deploy-prod:
              requires:
              - build
              filters:
                  branches:
                      only: master
        - deploy-staging:
              requires:
              -build
              filters:
                  branches:
                      only: staging

